<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1B263B">
    <link rel="manifest" href="manifest.json">
    <title>FC Perfumaria</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* ESTILO VISUAL */
        :root { --bg-color: #FDFBF7; --primary-color: #1B263B; --accent-color: #Cca43b; --text-color: #333; --whatsapp-green: #25D366; }
        body { font-family: 'Montserrat', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); padding-bottom: 120px; }
        
        header { background-color: #fff; color: var(--primary-color); padding: 1.5rem 1rem; text-align: center; border-bottom: 3px solid var(--accent-color); }
        .header-logo-text { font-family: 'Playfair Display', serif; font-size: 1.8rem; margin: 0; letter-spacing: 1px; color: var(--primary-color); }
        .header-sub { font-size: 0.85em; color: var(--accent-color); margin-top: 5px; font-weight: 500; text-transform: uppercase; letter-spacing: 2px; }

        /* SINO DE DIAGNÃ“STICO (VERMELHO PARA CHAMAR ATENÃ‡ÃƒO) */
        #notification-bell { 
            position: fixed; top: 20px; right: 20px; width: 50px; height: 50px; 
            background-color: #ffeb3b; border: 2px solid red; border-radius: 50%; 
            z-index: 9999; display: flex; align-items: center; justify-content: center; cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        #notification-bell i { color: red; font-size: 24px; }

        /* OUTROS ELEMENTOS */
        #install-app-btn { display: none; width: 100%; background-color: var(--primary-color); color: #fff; font-weight: bold; text-align: center; padding: 15px; border: none; cursor: pointer; }
        #ios-install-banner { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background-color: #fff; border-top: 1px solid #ccc; padding: 20px 15px; text-align: center; z-index: 3000; font-size: 0.9em; }
        #close-ios-banner { position: absolute; top: 10px; right: 15px; font-size: 20px; }

        #products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; max-width: 1200px; margin: 0 auto; }
        .product-card { background-color: #fff; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        .product-image-container { padding-top: 120%; position: relative; background-color: #f9f9f9; }
        .product-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .product-info { padding: 10px; text-align: center; }
    </style>
</head>
<body>
    <button id="install-app-btn">ðŸ“² INSTALAR APLICATIVO</button>
    <header id="main-header">
        <h1 class="header-logo-text">FC PERFUMARIA</h1>
        <div class="header-sub">EssÃªncia Brasileira no JapÃ£o</div>
    </header>

    <div id="notification-bell" onclick="testarNotificacao()"><i class="fas fa-bell"></i></div>

    <main>
        <div id="loading-message" style="text-align:center; padding:20px;">Carregando...</div>
        <div id="products-grid"></div>
    </main>

    <div id="ios-install-banner">
        <span id="close-ios-banner">&times;</span>
        <p>Instale para receber avisos: <strong>Compartilhar</strong> > <strong>Adicionar Ã  Tela de InÃ­cio</strong>.</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyDxyqFLm08rqlaemlyYI9gQfrjvddPelJs", authDomain: "fc-perfumaria-309fb.firebaseapp.com", projectId: "fc-perfumaria-309fb", storageBucket: "fc-perfumaria-309fb.firebasestorage.app", messagingSenderId: "311935363734", appId: "1:311935363734:web:a85cf6ccd93c67d594f0b7" };
        try { firebase.initializeApp(firebaseConfig); } catch(e){ alert("Erro Firebase: "+e.message); }
        const db = firebase.firestore();
        let messaging; try { if (firebase.messaging.isSupported()) { messaging = firebase.messaging(); } else { console.log("Push nÃ£o suportado neste navegador"); } } catch (e) {}

        // --- FUNÃ‡ÃƒO DE DIAGNÃ“STICO (CLIQUE NO SINO) ---
        async function testarNotificacao() {
            alert("PASSO 1: Iniciando teste...");
            
            if (!messaging) {
                alert("ERRO FATAL: Seu navegador/celular nÃ£o suporta notificaÃ§Ãµes ou o Firebase Messaging falhou ao carregar.");
                return;
            }

            if (Notification.permission === 'denied') {
                alert("ERRO: VocÃª BLOQUEOU as notificaÃ§Ãµes anteriormente. VÃ¡ nas configuraÃ§Ãµes do celular e desbloqueie o site.");
                return;
            }

            try {
                alert("PASSO 2: Pedindo permissÃ£o ao sistema...");
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    alert("PASSO 3: PermissÃ£o CONCEDIDA! Tentando gerar Token...");
                    
                    // Tenta pegar o Service Worker Ativo
                    const registration = await navigator.serviceWorker.ready;
                    
                    const token = await messaging.getToken({ 
                        vapidKey: 'BOdgxsn6TEz_y5Ub-xPuqvTHa6NkNzfhk6GlA7-UCoKMyIwBIffbOo2NQjPy27H_G5Qj0x4XgOF1gXyAvkS7_V8',
                        serviceWorkerRegistration: registration 
                    });

                    if (token) {
                        alert("PASSO 4: Token Gerado! " + token.substring(0, 10) + "...");
                        alert("PASSO 5: Tentando salvar no Firestore...");
                        
                        await db.collection('push_tokens').doc(token).set({
                            token: token,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            debug: "Teste DiagnÃ³stico"
                        });
                        
                        alert("SUCESSO TOTAL! ðŸ† Verifique a pasta push_tokens no Firebase agora.");
                    } else {
                        alert("ERRO: O Token veio vazio. Algo bloqueou a geraÃ§Ã£o.");
                    }
                } else {
                    alert("PermissÃ£o negada/fechada pelo usuÃ¡rio.");
                }
            } catch (e) {
                alert("ERRO TÃ‰CNICO NO PROCESSO: " + e.message);
            }
        }

        // --- CÃ“DIGO DA LOJA (MANTIDO SIMPLIFICADO) ---
        const grid = document.getElementById('products-grid');
        const loadingMsg = document.getElementById('loading-message');
        async function fetchAllProducts() {
            try {
                const snap = await db.collection("products").get();
                if(snap.empty){ loadingMsg.innerHTML = 'Loja vazia.'; return; }
                loadingMsg.style.display = 'none';
                snap.forEach(d => { 
                    let p = d.data();
                    const pf = (p.price||0).toLocaleString('ja-JP');
                    const card = document.createElement('div'); card.className = 'product-card';
                    card.innerHTML = `<div class="product-image-container"><img src="${p.imageUrl||''}" class="product-image"></div><div class="product-info"><h3>${p.name}</h3><p>Â¥${pf}</p></div>`;
                    grid.appendChild(card);
                });
            } catch(e) { loadingMsg.innerHTML = "Erro ao carregar produtos."; }
        }

        // PWA
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js'); }); }
        const isIos = () => /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
        if (isIos() && !('standalone' in window.navigator && window.navigator.standalone)) { document.getElementById('ios-install-banner').style.display = 'block'; }
        document.getElementById('close-ios-banner').addEventListener('click', () => { document.getElementById('ios-install-banner').style.display = 'none'; });

        document.addEventListener('DOMContentLoaded', fetchAllProducts);
    </script>
</body>
</html>
