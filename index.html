<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1B263B">
    <link rel="manifest" href="manifest.json">
    <title>FC Perfumaria</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS BRAZILIAN PREMIUM */
        :root { --bg-color: #FDFBF7; --primary-color: #1B263B; --accent-color: #Cca43b; --text-color: #333; --whatsapp-green: #25D366; }
        body { font-family: 'Montserrat', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); padding-bottom: 120px; }
        
        header { background-color: #fff; color: var(--primary-color); padding: 1.5rem 1rem; text-align: center; border-bottom: 3px solid var(--accent-color); }
        .header-logo-text { font-family: 'Playfair Display', serif; font-size: 1.8rem; margin: 0; letter-spacing: 1px; color: var(--primary-color); }
        .header-sub { font-size: 0.85em; color: var(--accent-color); margin-top: 5px; font-weight: 500; text-transform: uppercase; letter-spacing: 2px; }

        /* Botﾃ｣o Instalar Android */
        #install-app-btn { display: none; width: 100%; background-color: var(--primary-color); color: #fff; font-weight: bold; text-align: center; padding: 15px; border: none; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }

        /* Banner iOS */
        #ios-install-banner { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(255, 255, 255, 0.98); border-top: 1px solid #ccc; padding: 20px 15px; text-align: center; z-index: 3000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); box-sizing: border-box; color: #333; font-size: 0.9em; }
        #close-ios-banner { position: absolute; top: 10px; right: 15px; font-size: 20px; cursor: pointer; color: #888; }

        #search-container { position: relative; margin: 20px auto; max-width: 600px; padding: 0 15px; }
        #search-input { width: 100%; padding: 15px 45px 15px 20px; border: 1px solid #ddd; border-radius: 30px; font-size: 1em; outline: none; }
        .search-icon { position: absolute; right: 35px; top: 50%; transform: translateY(-50%); color: var(--accent-color); }
        
        #secao-filters { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0; padding: 0 10px; }
        .secao-button { background-color: #fff; color: var(--text-color); padding: 10px 18px; border-radius: 25px; border: 1px solid #ddd; font-size: 0.9em; font-weight: 500; cursor: pointer; transition: all 0.3s; }
        .secao-button.active { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); font-weight: 600; }

        #controls { display: flex; justify-content: center; margin-bottom: 20px; }
        .filter-button { background-color: transparent; color: var(--text-color); padding: 8px 15px; border: 1px solid var(--accent-color); border-radius: 4px; font-size: 0.85em; cursor: pointer; margin: 0 5px; }
        .filter-button.active { background-color: var(--accent-color); color: #fff; }

        .section-title { font-family: 'Playfair Display', serif; font-size: 1.8em; color: var(--primary-color); text-align: center; margin: 30px 0; }

        #products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 0 15px; max-width: 1200px; margin: 0 auto; }
        .product-card { background-color: #fff; border-radius: 8px; border: 1px solid #eee; overflow: hidden; text-decoration: none; color: var(--text-color); display: flex; flex-direction: column; position: relative; }
        .product-image-container { width: 100%; padding-top: 120%; position: relative; background-color: #f9f9f9; }
        .product-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .product-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; text-align: center; }
        .product-name { font-family: 'Playfair Display', serif; font-size: 1.1em; margin: 0 0 5px 0; color: var(--primary-color); }
        .product-price { font-weight: 700; margin-bottom: 10px; }
        .details-button { background-color: var(--primary-color); color: #fff; padding: 10px; width: 100%; border-radius: 4px; border: none; font-weight: 600; }
        
        .badge { position: absolute; top: 10px; left: 10px; padding: 5px 10px; border-radius: 2px; font-size: 0.75em; font-weight: bold; color: white; z-index: 10; text-transform: uppercase; letter-spacing: 1px; }
        .badge-novo { background-color: var(--accent-color); }
        .badge-esgotado { background-color: #666; right: 10px; left: auto; }

        footer { text-align: center; padding: 30px; margin-top: 40px; color: #666; border-top: 1px solid #eee; }
        #cart-icon { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background-color: var(--whatsapp-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-decoration: none; z-index: 1000; }
        #cart-count { position: absolute; top: 0; right: 0; background-color: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: none; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; }
        #notification-bell { position: fixed; top: 15px; right: 15px; font-size: 24px; color: var(--primary-color); cursor: pointer; z-index: 2000; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 50%; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* Loading Style */
        #loading-message { text-align: center; padding: 20px; color: var(--accent-color); font-weight: bold; }
    </style>
</head>
<body>
    <button id="install-app-btn">憧 INSTALAR APLICATIVO</button>

    <header id="main-header">
        <h1 class="header-logo-text">FC PERFUMARIA</h1>
        <div class="header-sub">Essﾃｪncia Brasileira no Japﾃ｣o</div>
    </header>

    <div id="notification-bell"><i class="far fa-bell"></i></div>

    <main>
        <div id="search-container"><input type="text" id="search-input" placeholder="Buscar perfume..."><i class="fas fa-search search-icon"></i></div>

        <div id="secao-filters">
            <button class="secao-button active" data-secao="todos">Todos</button>
            <button class="secao-button" data-secao="feminino">Feminino</button>
            <button class="secao-button" data-secao="masculino">Masculino</button>
            <button class="secao-button" data-secao="unissex">Unissex</button>
            <button class="secao-button" data-secao="infantil">Infantil</button>
            <button class="secao-button" data-secao="kits">Kits</button>
        </div>

        <div id="controls">
            <button class="filter-button active" data-filter="pronta-entrega">Pronta Entrega</button>
            <button class="filter-button" data-filter="sob-encomenda">Sob Encomenda</button>
        </div>

        <h2 id="collection-title" class="section-title">Loja Oficial</h2>
        
        <div id="loading-message">Conectando ao catﾃ｡logo...</div>
        <div id="products-grid"></div>
        <p id="search-no-results" style="display:none; text-align:center; color:#999;">Nenhum produto encontrado.</p>
    </main>

    <footer><p>ﾂｩ 2025 FC Perfumaria</p></footer>
    <a id="cart-icon" href="carrinho.html"><i class="fas fa-shopping-bag"></i><span id="cart-count">0</span></a>
    
    <div id="ios-install-banner">
        <span id="close-ios-banner">&times;</span>
        <p>Para instalar: Toque em <strong>Compartilhar</strong> <i class="fas fa-share-square" style="color:#007AFF;"></i> e <strong>Adicionar ﾃ Tela de Inﾃｭcio</strong>.</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>

    <script>
        // 1. CONFIGURAﾃﾃグ (Nﾃ｣o mexer)
        const firebaseConfig = { apiKey: "AIzaSyDxyqFLm08rqlaemlyYI9gQfrjvddPelJs", authDomain: "fc-perfumaria-309fb.firebaseapp.com", projectId: "fc-perfumaria-309fb", storageBucket: "fc-perfumaria-309fb.firebasestorage.app", messagingSenderId: "311935363734", appId: "1:311935363734:web:a85cf6ccd93c67d594f0b7" };
        
        // 2. INICIALIZAﾃﾃグ SEGURA
        try {
            firebase.initializeApp(firebaseConfig);
            var db = firebase.firestore();
            var messaging = null;
            try { if (firebase.messaging.isSupported()) messaging = firebase.messaging(); } catch (e) {}
        } catch (err) {
            document.getElementById('loading-message').innerHTML = "Erro Fatal Firebase: " + err.message;
        }

        // Variﾃ｡veis Globais
        const grid = document.getElementById('products-grid');
        const loadingMsg = document.getElementById('loading-message');
        const headerEl = document.getElementById('main-header');
        let currentFilter = 'pronta-entrega';
        let currentSecao = 'todos';
        let allProducts = [];

        // 3. FUNﾃﾃグ PRINCIPAL DE CARREGAMENTO (NUCLEAR)
        async function fetchAllProducts() {
            loadingMsg.style.display = 'block';
            loadingMsg.textContent = "Baixando produtos...";
            grid.innerHTML = '';
            
            try {
                // Busca bruta: pega tudo, sem filtros no banco
                const snap = await db.collection("products").get();
                
                if(snap.empty){
                    loadingMsg.textContent = "Loja vazia (Nenhum produto cadastrado).";
                    return;
                }

                // Salva na memﾃｳria
                allProducts = [];
                snap.forEach(d => {
                    let data = d.data();
                    // Cria campos de busca seguros (minﾃｺsculo)
                    data.searchSource = (data.source || '').toLowerCase().replace(' ', '-');
                    data.searchSecao = (data.secao || '').toLowerCase();
                    allProducts.push({ id: d.id, ...data });
                });

                renderProducts();
                
            } catch(e) {
                console.error(e);
                loadingMsg.style.color = 'red';
                loadingMsg.innerHTML = "Erro de Conexﾃ｣o:<br>" + e.message;
            }
        }

        // 4. FUNﾃﾃグ DE DESENHO (FILTRO LOCAL)
        function renderProducts() {
            loadingMsg.style.display = 'none';
            grid.innerHTML = '';

            let filtered = allProducts.filter(p => {
                let filterClean = currentFilter.toLowerCase().replace(' ', '-');
                // Se o produto nﾃ｣o tiver source, assume que ﾃｩ visﾃｭvel
                let matchSource = p.searchSource.includes(filterClean) || p.searchSource === '';
                let matchSecao = true;
                if (currentSecao !== 'todos') matchSecao = p.searchSecao === currentSecao;
                return matchSource && matchSecao;
            });

            if (filtered.length === 0) {
                grid.innerHTML = '<p style="text-align:center; color:#999; grid-column: 1/-1;">Nenhum item encontrado nesta seﾃｧﾃ｣o.</p>';
                return;
            }

            // Ordena por data (mais recente primeiro)
            filtered.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

            filtered.forEach(p => {
                const pf = (p.price||0).toLocaleString('ja-JP');
                let badge = '';
                if(p.isFeatured === 'novo') badge = '<span class="badge badge-novo">Lanﾃｧamento</span>';
                if((p.estoqueTotal||0) <= 0 && p.source === 'pronta-entrega') badge = '<span class="badge badge-esgotado">Esgotado</span>';
                
                const card = document.createElement('a'); card.href = `detalhes.html?id=${p.id}`; card.className = 'product-card';
                card.innerHTML = `${badge}<div class="product-image-container"><img src="${p.imageUrl||'https://via.placeholder.com/400'}" class="product-image"></div><div class="product-info"><div><div class="product-category">${p.secao}</div><h3 class="product-name">${p.name}</h3></div><div><div class="product-price">ﾂ･${pf}</div><button class="details-button">Ver Detalhes</button></div></div>`;
                grid.appendChild(card);
            });
        }

        // 5. AUXILIARES
        async function fetchSiteConfig(){ try{ const d=await db.collection("configuracoes").doc("siteInfo").get(); if(d.exists&&d.data().logoUrl) headerEl.innerHTML=`<img src="${d.data().logoUrl}" class="header-img"><div class="header-sub">Essﾃｪncia Brasileira no Japﾃ｣o</div>`; }catch(e){} }
        function updateCartIcon(){ const c=JSON.parse(localStorage.getItem('whatsappCart'))||{items:{}}; let q=0; Object.values(c.items).forEach(i=>q+=i.quantity); const b=document.getElementById('cart-count'); if(q>0){b.textContent=q;b.style.display='flex';}else{b.style.display='none';} }

        // 6. EVENTOS DE CLIQUE
        document.querySelectorAll('.secao-button').forEach(b => b.addEventListener('click', () => { 
            document.querySelectorAll('.secao-button').forEach(btn => btn.classList.remove('active')); 
            b.classList.add('active'); currentSecao = b.dataset.secao; renderProducts(); 
        }));

        document.querySelectorAll('.filter-button').forEach(b => b.addEventListener('click', () => { 
            document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active')); 
            b.classList.add('active'); currentFilter = b.dataset.filter; renderProducts(); 
        }));

        document.getElementById('search-input').addEventListener('input', (e) => { 
            const term = e.target.value.toLowerCase(); 
            const cards = document.querySelectorAll('.product-card'); 
            let hasResult = false; 
            cards.forEach(c => { 
                if(c.querySelector('.product-name').textContent.toLowerCase().includes(term)){c.style.display='flex';hasResult=true;}
                else{c.style.display='none';} 
            }); 
            document.getElementById('search-no-results').style.display = hasResult?'none':'block'; 
        });

        // 7. PWA / INSTALAﾃﾃグ
        // Separado e protegido com try/catch para nﾃ｣o travar a loja
        try {
            let deferredPrompt;
            const installBtn = document.getElementById('install-app-btn');
            const iosBanner = document.getElementById('ios-install-banner');
            
            window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.style.display = 'block'; });
            installBtn.addEventListener('click', () => { installBtn.style.display = 'none'; if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; } });

            const isIos = () => /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
            const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);
            
            if (isIos() && !isInStandaloneMode()) {
                iosBanner.style.display = 'block';
                document.getElementById('cart-icon').style.bottom = '100px';
            }
            document.getElementById('close-ios-banner').addEventListener('click', () => {
                iosBanner.style.display = 'none';
                document.getElementById('cart-icon').style.bottom = '20px';
            });

            if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js'); }); }
        } catch(errPwa) {
            console.log("Erro PWA (Ignorado):", errPwa);
        }

        // Navegaﾃｧﾃ｣o Secreta
        let tapCount=0; headerEl.addEventListener('click', ()=>{ tapCount++; if(tapCount===3) window.location.href='admin.html'; setTimeout(()=>tapCount=0,1000); });

        // Inicializaﾃｧﾃ｣o
        document.addEventListener('DOMContentLoaded', ()=>{ 
            fetchSiteConfig(); 
            updateCartIcon(); 
            fetchAllProducts(); 
        });
    </script>
</body>
</html>
