<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="theme-color" content="#1B263B"> <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    
    <title>FC Perfumaria | Essência Brasileira no Japão</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg-color: #FDFBF7; /* Off-White */
            --primary-color: #1B263B; /* Azul Marinho */
            --accent-color: #Cca43b; /* Bronze */
            --text-color: #333333; 
            --light-text: #666; 
            --border-color: #e0e0e0; 
            --whatsapp-green: #25D366; 
        }
        
        body { font-family: 'Montserrat', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); padding-bottom: 80px; }
        
        /* HEADER - LIMPO */
        header { background-color: #fff; color: var(--primary-color); padding: 1.5rem 1rem; text-align: center; border-bottom: 3px solid var(--accent-color); position: relative; }
        .header-logo-text { font-family: 'Playfair Display', serif; font-size: 1.8rem; margin: 0; letter-spacing: 1px; color: var(--primary-color); line-height: 1.2; }
        .header-sub { font-size: 0.85em; color: var(--accent-color); margin-top: 5px; font-weight: 500; text-transform: uppercase; letter-spacing: 2px; }
        .header-img { max-height: 70px; display: block; margin: 0 auto 8px auto; }

        /* NOTIFICAÇÃO E CARRINHO */
        #notification-bell { position: fixed; top: 15px; right: 15px; font-size: 24px; color: var(--primary-color); cursor: pointer; z-index: 2000; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 50%; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        main { max-width: 1200px; margin: 20px auto; padding: 0 15px; }

        /* BUSCA */
        #search-container { position: relative; margin-bottom: 25px; max-width: 600px; margin-left: auto; margin-right: auto; }
        #search-input { width: 100%; padding: 15px 45px 15px 20px; border: 1px solid #ddd; border-radius: 30px; font-size: 1em; outline: none; transition: 0.3s; background: #fff; font-family: 'Montserrat', sans-serif; }
        #search-input:focus { border-color: var(--accent-color); box-shadow: 0 0 8px rgba(204, 164, 59, 0.2); }
        .search-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: var(--accent-color); }
        
        /* FILTROS DE CATEGORIA */
        #secao-filters { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .secao-button { background-color: #fff; color: var(--text-color); padding: 10px 18px; border-radius: 25px; border: 1px solid #ddd; font-size: 0.9em; font-weight: 500; cursor: pointer; transition: all 0.3s; font-family: 'Montserrat', sans-serif; }
        .secao-button.active { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); font-weight: 600; box-shadow: 0 4px 10px rgba(27, 38, 59, 0.3); }

        /* FILTRO PRONTA ENTREGA */
        #controls { display: flex; justify-content: center; margin-bottom: 20px; }
        .filter-button { background-color: transparent; color: var(--text-color); padding: 8px 15px; border: 1px solid var(--accent-color); border-radius: 4px; font-size: 0.85em; cursor: pointer; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .filter-button.active { background-color: var(--accent-color); color: #fff; }

        .section-title { font-family: 'Playfair Display', serif; font-size: 1.8em; color: var(--primary-color); margin: 30px 0 20px 0; text-align: center; }

        /* GRADE DE PRODUTOS */
        #products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        
        .product-card { background-color: #fff; border-radius: 8px; border: 1px solid #eee; overflow: hidden; text-decoration: none; color: var(--text-color); transition: transform 0.3s; position: relative; display: flex; flex-direction: column; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        
        .product-image-container { width: 100%; padding-top: 120%; position: relative; background-color: #f9f9f9; overflow: hidden; }
        .product-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        
        .product-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; text-align: center; }
        .product-name { font-family: 'Playfair Display', serif; font-size: 1.1em; margin: 0 0 5px 0; color: var(--primary-color); line-height: 1.2; }
        .product-category { font-size: 0.75em; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .product-price { font-size: 1.1em; font-weight: 700; color: var(--text-color); margin-bottom: 12px; }
        
        .details-button { background-color: var(--primary-color); color: #fff; padding: 12px 0; width: 100%; border-radius: 4px; font-weight: 600; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; border: none; cursor: pointer; transition: 0.3s; margin-top: auto; }
        
        /* BADGES */
        .badge { position: absolute; top: 10px; left: 10px; padding: 5px 10px; border-radius: 2px; font-size: 0.75em; font-weight: bold; color: white; z-index: 10; text-transform: uppercase; letter-spacing: 1px; }
        .badge-novo { background-color: var(--accent-color); }
        .badge-destaque { background-color: var(--primary-color); }
        .badge-esgotado { background-color: #666; right: 10px; left: auto; }

        footer { text-align: center; padding: 30px; margin-top: 40px; color: var(--light-text); font-size: 0.85em; background: #fff; border-top: 1px solid #eee; }
        
        #cart-icon { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background-color: var(--whatsapp-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4); cursor: pointer; z-index: 1000; text-decoration: none; transition: transform 0.2s; }
        #cart-count { position: absolute; top: 0; right: 0; background-color: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; display: none; }

        /* MODAIS */
        #push-permission-modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(27, 38, 59, 0.8); align-items: center; justify-content: center; }
        .push-modal-content { background: #fff; width: 85%; max-width: 350px; padding: 30px; border-radius: 8px; text-align: center; }
        .push-btn-allow { background: var(--accent-color); color: #fff; border: none; padding: 12px; width: 100%; border-radius: 4px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        
        @media (min-width: 768px) { #products-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); } }
    </style>
</head>
<body>
    
    <div id="push-permission-modal">
        <div class="push-modal-content">
            <i class="fas fa-bell" style="font-size: 40px; color: var(--accent-color); margin-bottom:15px;"></i>
            <h3 style="margin:0 0 10px 0; color:var(--primary-color);">Novidades Exclusivas</h3>
            <p style="color:#666; font-size:0.9em;">Ative as notificações para saber quando chegar reposição dos seus perfumes favoritos.</p>
            <button class="push-btn-allow" id="allow-push-btn">ATIVAR AVISOS</button>
            <button style="background:none; border:none; color:#999; margin-top:10px; cursor:pointer;" id="deny-push-btn">Agora não</button>
        </div>
    </div>

    <div id="notification-bell"><i class="far fa-bell"></i></div>

    <header id="main-header">
        <h1 class="header-logo-text">FC PERFUMARIA</h1>
        <div class="header-sub">Essência Brasileira no Japão</div>
    </header>

    <main>
        <div id="search-container">
            <input type="text" id="search-input" placeholder="Buscar perfume (ex: Malbec, Lily)...">
            <i class="fas fa-search search-icon"></i>
        </div>

        <div id="secao-filters">
            <button class="secao-button active" data-secao="todos">Todos</button>
            <button class="secao-button" data-secao="feminino">Feminino</button>
            <button class="secao-button" data-secao="masculino">Masculino</button>
            <button class="secao-button" data-secao="unissex">Unissex</button>
            <button class="secao-button" data-secao="infantil">Infantil</button>
            <button class="secao-button" data-secao="kits">Kits</button>
        </div>

        <div id="controls">
            <button class="filter-button active" data-filter="pronta-entrega">Pronta Entrega</button>
            <button class="filter-button" data-filter="sob-encomenda" style="margin-left:10px;">Sob Encomenda</button>
        </div>

        <h2 id="collection-title" class="section-title">Coleção Completa</h2>
        <div style="text-align: center; color: #999; font-size: 0.9em; margin-bottom: 20px;" id="filter-details">Envio imediato para todo o Japão.</div>

        <div id="products-grid"></div>
        <div id="loading-message" style="text-align:center; padding:20px; color:var(--accent-color);">Carregando essências...</div>
        <p id="search-no-results" style="display:none; text-align:center; color:#999;">Nenhum perfume encontrado com esse nome.</p>
    </main>

    <footer>
        <p>© 2025 FC Perfumaria. Todos os direitos reservados.</p>
    </footer>

    <a id="cart-icon" href="carrinho.html">
        <i class="fas fa-shopping-bag"></i>
        <span id="cart-count">0</span>
    </a>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
    
    <script>
        // CONFIGURAÇÃO FC PERFUMARIA
        const firebaseConfig = {
            apiKey: "AIzaSyDxyqFLm08rqlaemlyYI9gQfrjvddPelJs",
            authDomain: "fc-perfumaria-309fb.firebaseapp.com",
            projectId: "fc-perfumaria-309fb",
            storageBucket: "fc-perfumaria-309fb.firebasestorage.app",
            messagingSenderId: "311935363734",
            appId: "1:311935363734:web:a85cf6ccd93c67d594f0b7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let messaging; try { if (firebase.messaging.isSupported()) { messaging = firebase.messaging(); } } catch (e) { console.log("Messaging not supported"); }

        const grid = document.getElementById('products-grid');
        const loadingMsg = document.getElementById('loading-message');
        const headerEl = document.getElementById('main-header');
        
        let currentFilter = 'pronta-entrega';
        let currentSecao = 'todos';

        // Carregar Configurações (Logo)
        async function fetchSiteConfig(){
            try{
                const d = await db.collection("configuracoes").doc("siteInfo").get();
                if(d.exists && d.data().logoUrl){
                    headerEl.innerHTML = `<img src="${d.data().logoUrl}" class="header-img"><div class="header-sub">Essência Brasileira no Japão</div>`;
                }
            } catch(e){}
        }

        // Buscar Produtos (Modo Produção - Limpo)
        async function fetchProducts() {
            loadingMsg.style.display = 'block';
            loadingMsg.textContent = 'Carregando essências...';
            grid.innerHTML = '';
            
            try {
                let q = db.collection("products");
                if(currentSecao !== 'todos') q = q.where("secao", "==", currentSecao);
                q = q.where("source", "==", currentFilter).orderBy("createdAt", "desc");
                
                const snap = await q.get();
                
                if(snap.empty){
                    loadingMsg.style.display = 'none';
                    grid.innerHTML = '<p style="text-align:center; grid-column:1/-1; color:#999;">Nenhum perfume encontrado nesta categoria.</p>';
                    return;
                }

                snap.forEach(d => {
                    const p = d.data();
                    const pf = (p.price||0).toLocaleString('ja-JP');
                    
                    let badge = '';
                    if(p.isFeatured === 'novo') badge = '<span class="badge badge-novo">Lançamento</span>';
                    else if(p.isFeatured === 'destaque') badge = '<span class="badge badge-destaque">Destaque</span>';
                    if((p.estoqueTotal||0) <= 0 && p.source === 'pronta-entrega') badge = '<span class="badge badge-esgotado">Esgotado</span>';

                    const card = document.createElement('a');
                    card.href = `detalhes.html?id=${d.id}`;
                    card.className = 'product-card';
                    card.innerHTML = `
                        ${badge}
                        <div class="product-image-container">
                            <img src="${p.imageUrl || 'https://via.placeholder.com/400x500?text=FC+Perfumaria'}" class="product-image" loading="lazy">
                        </div>
                        <div class="product-info">
                            <div>
                                <div class="product-category">${p.secao}</div>
                                <h3 class="product-name">${p.name}</h3>
                            </div>
                            <div>
                                <div class="product-price">¥${pf}</div>
                                <button class="details-button">Ver Detalhes</button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                loadingMsg.style.display = 'none';
                
            } catch(e) {
                console.error(e);
                loadingMsg.style.color = 'red';
                // Caso extremo de erro
                loadingMsg.innerHTML = `Erro de conexão. Tente atualizar a página.`;
            }
        }

        // Filtros
        document.querySelectorAll('.secao-button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.secao-button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentSecao = btn.dataset.secao;
                document.getElementById('collection-title').textContent = btn.textContent;
                fetchProducts();
            });
        });

        document.querySelectorAll('.filter-button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                document.getElementById('filter-details').textContent = currentFilter === 'pronta-entrega' ? 'Envio imediato para todo o Japão.' : 'Produtos sob encomenda (Prazo de 15 a 20 dias).';
                fetchProducts();
            });
        });

        // Busca
        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('.product-card');
            let hasResult = false;
            cards.forEach(card => {
                const name = card.querySelector('.product-name').textContent.toLowerCase();
                if(name.includes(term)) { card.style.display = 'flex'; hasResult = true; }
                else { card.style.display = 'none'; }
            });
            document.getElementById('search-no-results').style.display = hasResult ? 'none' : 'block';
        });

        // Carrinho Icone
        function updateCartIcon(){
            const c = JSON.parse(localStorage.getItem('whatsappCart')) || {items:{}};
            let q = 0; Object.values(c.items).forEach(i => q += i.quantity);
            const badge = document.getElementById('cart-count');
            if(q > 0) { badge.textContent = q; badge.style.display = 'flex'; }
            else badge.style.display = 'none';
        }

        // Push Notification
        const pushModal = document.getElementById('push-permission-modal');
        if(Notification.permission === 'default') {
            setTimeout(() => { pushModal.style.display = 'flex'; }, 3000);
        }
        document.getElementById('allow-push-btn').addEventListener('click', async () => {
            pushModal.style.display = 'none';
            if(messaging){
                try {
                    await Notification.requestPermission();
                    const token = await messaging.getToken({ vapidKey: 'BInIXSUQdmOW6xyauTrERRsEgA0QtupR2fmDrhIckU-QA2sLBCJQnKsJk1eK40esRAW3EGYWQMz1WOnVHaIsPPA' });
                    if(token) await db.collection('push_tokens').doc(token).set({token, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
                } catch(e){}
            }
        });
        document.getElementById('deny-push-btn').addEventListener('click', () => pushModal.style.display = 'none');
        document.getElementById('notification-bell').addEventListener('click', () => { alert('Nenhuma notificação nova.'); });

        // Navegação Secreta para Admin
        let tapCount = 0;
        headerEl.addEventListener('click', () => {
            tapCount++;
            if(tapCount === 3) window.location.href = 'admin.html';
            setTimeout(() => tapCount = 0, 1000);
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchProducts();
            fetchSiteConfig();
            updateCartIcon();
        });
    </script>
</body>
</html>
