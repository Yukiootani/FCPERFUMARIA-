<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1B263B">
    <link rel="manifest" href="manifest.json">
    <title>FC Perfumaria</title>
    
    <link rel="apple-touch-icon" href="663adacb-9398-45a8-9e83-f0dcf0e1f4ef.png">
    <link rel="icon" type="image/png" href="663adacb-9398-45a8-9e83-f0dcf0e1f4ef.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILO VISUAL --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        html, body { width: 100%; max-width: 100%; overflow-x: hidden; position: relative; font-family: 'Montserrat', sans-serif; background-color: #FDFBF7; color: #333; }
        body { padding-bottom: 120px; -webkit-font-smoothing: antialiased; }
        :root { --bg-color: #FDFBF7; --primary-color: #1B263B; --accent-color: #Cca43b; --text-color: #333; --whatsapp-green: #25D366; }
        
        header { background-color: #fff; color: var(--primary-color); padding: 1rem; text-align: center; border-bottom: 3px solid var(--accent-color); padding-top: max(1.5rem, env(safe-area-inset-top)); }
        
        .header-img { 
            max-height: 130px; /* LOGO GRANDE */
            width: auto; 
            display: block; 
            margin: 0 auto 5px auto; 
        }

        .header-sub { font-size: 0.8em; color: var(--accent-color); margin-top: 0; font-weight: 500; text-transform: uppercase; letter-spacing: 2px; }

        #notification-bell { position: fixed; top: max(15px, env(safe-area-inset-top)); right: 15px; width: 42px; height: 42px; background-color: #fff; border-radius: 50%; z-index: 9990; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid var(--primary-color); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        #notification-bell svg { width: 20px; height: 20px; fill: var(--primary-color); }

        #inbox-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; align-items: flex-start; justify-content: center; padding-top: 80px; backdrop-filter: blur(3px); }
        .inbox-content { background: #fff; width: 90%; max-width: 400px; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.3); animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .inbox-header { background: var(--primary-color); color: #fff; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-family: 'Playfair Display', serif; letter-spacing: 1px; }
        .close-inbox { font-size: 24px; cursor: pointer; line-height: 1; }
        #inbox-list { list-style: none; max-height: 60vh; overflow-y: auto; padding: 0; margin: 0; }
        .inbox-item { padding: 15px; border-bottom: 1px solid #eee; transition: background 0.2s; }
        .inbox-item h4 { margin: 0 0 5px 0; color: var(--primary-color); font-size: 1em; font-weight: 700; }
        .inbox-item p { margin: 0; color: #666; font-size: 0.9em; line-height: 1.4; }
        .inbox-date { font-size: 0.75em; color: #999; margin-top: 8px; text-align: right; display: block; }
        .inbox-empty { padding: 30px; text-align: center; color: #999; font-style: italic; }

        #install-app-btn { display: none; width: 100%; background-color: var(--primary-color); color: #fff; font-weight: bold; text-align: center; padding: 15px; border: none; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; padding-top: max(15px, env(safe-area-inset-top)); }
        
        /* BANNER IOS - COM √çCONE DE MAIS (+) */
        #ios-install-banner { 
            display: none; 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background-color: #f0f0f0; 
            border-top: 1px solid #ccc; 
            padding: 20px 15px; 
            padding-bottom: max(20px, env(safe-area-inset-bottom)); 
            text-align: center; 
            z-index: 3000; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); 
            font-size: 0.95em; 
            color: #333; 
        }
        #ios-install-banner p { margin: 0; line-height: 1.5; }
        #close-ios-banner { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #888; padding: 5px; }
        .ios-icon { color: #007AFF; font-size: 1.2em; margin: 0 3px; vertical-align: text-bottom; }

        main { width: 100%; max-width: 600px; margin: 0 auto; padding: 0 15px; overflow: hidden; }
        #search-container { position: relative; margin: 20px auto; width: 100%; }
        #search-input { width: 100%; padding: 12px 40px 12px 20px; border: 1px solid #ddd; border-radius: 30px; font-size: 1em; outline: none; background: #fff; }
        .search-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: var(--accent-color); }
        
        #secao-filters { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 20px 0; width: 100%; }
        .secao-button { background-color: #fff; color: var(--text-color); padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; font-size: 0.85em; font-weight: 500; cursor: pointer; transition: all 0.3s; white-space: nowrap; }
        .secao-button.active { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); font-weight: 600; }

        #controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; width: 100%; }
        .filter-button { background-color: transparent; color: var(--text-color); padding: 8px 12px; border: 1px solid var(--accent-color); border-radius: 4px; font-size: 0.8em; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; }
        .filter-button.active { background-color: var(--accent-color); color: #fff; }

        .section-title { font-family: 'Playfair Display', serif; font-size: 1.6em; color: var(--primary-color); text-align: center; margin: 20px 0; }

        #products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding-bottom: 20px; }
        .product-card { background-color: #fff; border-radius: 8px; border: 1px solid #eee; overflow: hidden; text-decoration: none; color: var(--text-color); display: flex; flex-direction: column; position: relative; width: 100%; }
        .product-image-container { width: 100%; padding-top: 120%; position: relative; background-color: #f9f9f9; }
        .product-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .product-info { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; text-align: center; }
        .product-name { font-family: 'Playfair Display', serif; font-size: 1em; margin: 0 0 5px 0; color: var(--primary-color); line-height: 1.2; }
        .product-price { font-weight: 700; margin-bottom: 8px; font-size: 0.95em; }
        .details-button { background-color: var(--primary-color); color: #fff; padding: 8px; width: 100%; border-radius: 4px; border: none; font-weight: 600; font-size: 0.8em; }
        .badge { position: absolute; top: 5px; left: 5px; padding: 4px 8px; border-radius: 2px; font-size: 0.65em; font-weight: bold; color: white; z-index: 10; text-transform: uppercase; }
        .badge-novo { background-color: var(--accent-color); }
        .badge-esgotado { background-color: #666; right: 5px; left: auto; }

        footer { text-align: center; padding: 30px; margin-top: 20px; color: #666; border-top: 1px solid #eee; font-size: 0.8em; }
        #cart-icon { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background-color: var(--whatsapp-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-decoration: none; z-index: 9990; }
        #cart-count { position: absolute; top: -5px; right: -5px; background-color: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: none; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; }
        
        #push-permission-modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(27, 38, 59, 0.8); align-items: center; justify-content: center; }
        .push-modal-content { background: #fff; width: 85%; max-width: 320px; padding: 25px; border-radius: 8px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
        .push-btn-allow { background: var(--accent-color); color: #fff; border: none; padding: 12px; width: 100%; border-radius: 4px; font-weight: bold; margin-top: 15px; cursor: pointer; }
    </style>
</head>
<body>
    <button id="install-app-btn">üì≤ INSTALAR APLICATIVO</button>
    
    <header id="main-header">
        <img src="663adacb-9398-45a8-9e83-f0dcf0e1f4ef.png" alt="FC Perfumaria" class="header-img">
        <div class="header-sub">Ess√™ncia Brasileira no Jap√£o</div>
    </header>

    <div id="notification-bell" onclick="handleBellClick()"><svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg></div>
    <div id="inbox-modal"><div class="inbox-content"><div class="inbox-header"><span>Novidades</span><span class="close-inbox" onclick="document.getElementById('inbox-modal').style.display='none'">&times;</span></div><ul id="inbox-list"><li class="inbox-empty">Carregando...</li></ul></div></div>

    <main>
        <div id="search-container"><input type="text" id="search-input" placeholder="Buscar perfume..."><i class="fas fa-search search-icon"></i></div>
        <div id="secao-filters"><button class="secao-button active" data-secao="todos">Todos</button><button class="secao-button" data-secao="feminino">Feminino</button><button class="secao-button" data-secao="masculino">Masculino</button><button class="secao-button" data-secao="unissex">Unissex</button><button class="secao-button" data-secao="infantil">Infantil</button><button class="secao-button" data-secao="kits">Kits</button></div>
        <div id="controls"><button class="filter-button active" data-filter="pronta-entrega">Pronta Entrega</button><button class="filter-button" data-filter="sob-encomenda">Sob Encomenda</button></div>
        <h2 id="collection-title" class="section-title">Loja Oficial</h2>
        <div id="loading-message" style="text-align:center; padding:20px; color:var(--accent-color);">Carregando cat√°logo...</div>
        <div id="products-grid"></div>
        <p id="search-no-results" style="display:none; text-align:center; color:#999; padding:20px;">Nenhum produto encontrado.</p>
    </main>

    <footer><p>¬© 2025 FC Perfumaria</p></footer>
    <a id="cart-icon" href="carrinho.html"><i class="fas fa-shopping-bag"></i><span id="cart-count">0</span></a>
    
    <div id="ios-install-banner">
        <span id="close-ios-banner">&times;</span>
        <p>Para instalar o App:</p>
        <p style="margin-top: 10px;">
            1. Toque em <strong>Compartilhar</strong> 
            <i class="fa-solid fa-arrow-up-from-bracket ios-icon"></i>
        </p>
        <p style="margin-top: 5px;">
            2. Toque em <strong>Adicionar √† Tela de In√≠cio</strong> 
            <i class="far fa-plus-square ios-icon"></i>
        </p>
    </div>

    <div id="push-permission-modal"><div class="push-modal-content"><i class="fas fa-bell" style="font-size: 40px; color: var(--accent-color); margin-bottom:15px;"></i><h3 style="margin:0 0 10px 0; color:var(--primary-color);">Ativar Avisos?</h3><p style="color:#666; font-size:0.9em;">Receba ofertas e novidades direto no celular.</p><button class="push-btn-allow" id="allow-push-btn">SIM, ATIVAR</button><button style="background:none; border:none; color:#999; margin-top:10px; cursor:pointer;" id="deny-push-btn">Agora n√£o</button></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyDxyqFLm08rqlaemlyYI9gQfrjvddPelJs", authDomain: "fc-perfumaria-309fb.firebaseapp.com", projectId: "fc-perfumaria-309fb", storageBucket: "fc-perfumaria-309fb.firebasestorage.app", messagingSenderId: "311935363734", appId: "1:311935363734:web:a85cf6ccd93c67d594f0b7" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let messaging; try { if (firebase.messaging.isSupported()) { messaging = firebase.messaging(); } } catch (e) {}

        function clearBadge() { try { if ('setAppBadge' in navigator) navigator.setAppBadge(0); if ('clearAppBadge' in navigator) navigator.clearAppBadge(); } catch(e) { } }
        clearBadge(); document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') clearBadge(); });

        // PWA
        let deferredPrompt; const installBtn=document.getElementById('install-app-btn'); const iosBanner=document.getElementById('ios-install-banner');
        window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;installBtn.style.display='block'; tryShowPopup();});
        installBtn.addEventListener('click',()=>{installBtn.style.display='none';if(deferredPrompt){deferredPrompt.prompt();deferredPrompt=null}});
        
        // DETEC√á√ÉO IOS INTELIGENTE (Se fechou antes, n√£o mostra)
        const isIos=()=>{return /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase())};
        const isStandalone = window.navigator.standalone === true || (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches);
        const bannerDismissed = localStorage.getItem('iosBannerDismissed') === 'true';

        if(isIos() && !isStandalone && !bannerDismissed){
            iosBanner.style.display='block';
            document.getElementById('cart-icon').style.bottom='160px'; // Sobe o carrinho
        }
        document.getElementById('close-ios-banner').addEventListener('click',()=>{
            iosBanner.style.display='none';
            document.getElementById('cart-icon').style.bottom='20px';
            localStorage.setItem('iosBannerDismissed', 'true');
        });
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try { navigator.serviceWorker.register('/sw.js'); } catch(e){}
            });
        }

        const grid=document.getElementById('products-grid'), loadingMsg=document.getElementById('loading-message');
        let currentFilter='pronta-entrega', currentSecao='todos', allProducts=[];
        
        async function fetchSiteConfig(){ }

        async function fetchAllProducts() {
            loadingMsg.style.display='block'; grid.innerHTML='';
            try {
                const snap = await db.collection("products").get();
                if(snap.empty){ loadingMsg.style.display='none'; grid.innerHTML='<p style="text-align:center;color:#999;">Loja vazia.</p>'; return; }
                allProducts = [];
                snap.forEach(d => { let data = d.data(); data.searchSource = (data.source || '').toLowerCase().replace(' ', '-'); data.searchSecao = (data.secao || '').toLowerCase(); allProducts.push({ id: d.id, ...data }); });
                renderProducts();
            } catch(e) { loadingMsg.style.color='red'; loadingMsg.innerHTML="Erro de conex√£o."; }
        }
        function renderProducts() {
            loadingMsg.style.display='none'; grid.innerHTML='';
            let filtered = allProducts.filter(p => {
                let matchSource = p.searchSource.includes(currentFilter.toLowerCase().replace(' ', '-')) || p.searchSource === '';
                let matchSecao = currentSecao === 'todos' || p.searchSecao === currentSecao;
                return matchSource && matchSecao;
            });
            if (filtered.length === 0) { grid.innerHTML = '<p style="text-align:center;color:#999;grid-column:1/-1;">Nenhum item aqui.</p>'; return; }
            filtered.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            filtered.forEach(p => {
                const pf = (p.price||0).toLocaleString('ja-JP');
                let badge = p.isFeatured === 'novo' ? '<span class="badge badge-novo">Lan√ßamento</span>' : '';
                if((p.estoqueTotal||0) <= 0 && p.source === 'pronta-entrega') badge = '<span class="badge badge-esgotado">Esgotado</span>';
                const card = document.createElement('a'); card.href = `detalhes.html?id=${p.id}`; card.className = 'product-card';
                card.innerHTML = `${badge}<div class="product-image-container"><img src="${p.imageUrl||'https://via.placeholder.com/400'}" class="product-image"></div><div class="product-info"><div><div class="product-category">${p.secao}</div><h3 class="product-name">${p.name}</h3></div><div><div class="product-price">¬•${pf}</div><button class="details-button">Ver Detalhes</button></div></div>`;
                grid.appendChild(card);
            });
        }
        document.querySelectorAll('.secao-button').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.secao-button').forEach(btn=>btn.classList.remove('active'));b.classList.add('active');currentSecao=b.dataset.secao;renderProducts()}));
        document.querySelectorAll('.filter-button').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.filter-button').forEach(btn=>btn.classList.remove('active'));b.classList.add('active');currentFilter=b.dataset.filter;renderProducts()}));
        document.getElementById('search-input').addEventListener('input',(e)=>{const t=e.target.value.toLowerCase();const c=document.querySelectorAll('.product-card');c.forEach(card=>{if(card.querySelector('.product-name').textContent.toLowerCase().includes(t)){card.style.display='flex'}else{card.style.display='none'}})});
        function updateCartIcon(){const c=JSON.parse(localStorage.getItem('whatsappCart'))||{items:{}};let q=0;Object.values(c.items).forEach(i=>q+=i.quantity);const b=document.getElementById('cart-count');if(q>0){b.textContent=q;b.style.display='flex'}else{b.style.display='none';} }
        let tapCount=0; document.getElementById('main-header').addEventListener('click', ()=>{ tapCount++; if(tapCount===3) window.location.href='admin.html'; setTimeout(()=>tapCount=0,1000); });

        async function handleBellClick() {
            if (Notification.permission === 'granted') { openInbox(); } else { requestPermission(); }
        }
        async function requestPermission() {
            if (!('Notification' in window)) { alert("Sem suporte."); return; }
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted' && messaging) {
                    const token = await messaging.getToken({ vapidKey: 'BOdgxsn6TEz_y5Ub-xPuqvTHa6NkNzfhk6GlA7-UCoKMyIwBIffbOo2NQjPy27H_G5Qj0x4XgOF1gXyAvkS7_V8' });
                    if(token) {
                        await db.collection('push_tokens').doc(token).set({token, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
                        alert("Sucesso! Avisos ativados.");
                    }
                }
            } catch(e) { console.log(e); }
        }
        async function openInbox() {
            const modal = document.getElementById('inbox-modal');
            const list = document.getElementById('inbox-list');
            modal.style.display = 'flex';
            list.innerHTML = '<li class="inbox-empty">Buscando mensagens...</li>';
            try {
                const snap = await db.collection('site_messages').orderBy('createdAt', 'desc').limit(10).get();
                list.innerHTML = '';
                if (snap.empty) { list.innerHTML = '<li class="inbox-empty">Nenhuma novidade.</li>'; return; }
                snap.forEach(doc => {
                    const m = doc.data();
                    const date = m.createdAt ? m.createdAt.toDate().toLocaleDateString('pt-BR') : '';
                    const li = document.createElement('li'); li.className = 'inbox-item';
                    li.innerHTML = `<h4>${m.title}</h4><p>${m.body}</p><span class="inbox-date">${date}</span>`;
                    list.appendChild(li);
                });
            } catch (e) { list.innerHTML = '<li class="inbox-empty">Erro ao carregar.</li>'; }
        }
        document.getElementById('notification-bell').addEventListener('click', handleBellClick);
        document.getElementById('inbox-modal').addEventListener('click', (e) => { if(e.target.id === 'inbox-modal') e.target.style.display = 'none'; });
        
        const pushModal = document.getElementById('push-permission-modal');
        function tryShowPopup() {
            if('Notification' in window && Notification.permission === 'default') { pushModal.style.display = 'flex'; }
        }
        tryShowPopup();

        document.getElementById('allow-push-btn').addEventListener('click', () => { pushModal.style.display = 'none'; requestPermission(); });
        document.getElementById('deny-push-btn').addEventListener('click', () => pushModal.style.display = 'none');

        document.addEventListener('DOMContentLoaded', ()=>{ fetchSiteConfig(); updateCartIcon(); fetchAllProducts(); });
    </script>
</body>
</html>
