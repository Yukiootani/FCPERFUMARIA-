<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico FC Perfumaria</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #fff; color: #333; }
        h2 { border-bottom: 2px solid #333; padding-bottom: 10px; }
        .box { padding: 15px; border: 1px solid #ccc; margin-bottom: 15px; border-radius: 5px; background: #f9f9f9; }
        .log { font-family: monospace; font-size: 13px; margin-bottom: 5px; }
        .error { color: red; font-weight: bold; background: #ffe6e6; padding: 10px; border: 1px solid red; }
        .success { color: green; font-weight: bold; background: #e6ffe6; padding: 10px; border: 1px solid green; }
        button { padding: 15px; font-size: 16px; width: 100%; background: #333; color: white; border: none; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>
    <h2>üïµÔ∏è Modo Diagn√≥stico</h2>
    <p>Testando conex√£o com o Firebase...</p>

    <div id="status-area">Iniciando teste...</div>
    <div id="results-area"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyDxyqFLm08rqlaemlyYI9gQfrjvddPelJs", 
            authDomain: "fc-perfumaria-309fb.firebaseapp.com", 
            projectId: "fc-perfumaria-309fb", 
            storageBucket: "fc-perfumaria-309fb.firebasestorage.app", 
            messagingSenderId: "311935363734", 
            appId: "1:311935363734:web:a85cf6ccd93c67d594f0b7" 
        };

        const statusDiv = document.getElementById('status-area');
        const resDiv = document.getElementById('results-area');

        function log(msg, type = 'log') {
            statusDiv.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        }

        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            log("‚úÖ Firebase iniciado.");

            // TESTE 1: Conex√£o Simples (Sem filtros)
            log("‚è≥ Teste 1: Lendo 1 produto qualquer...");
            
            db.collection("products").limit(1).get()
            .then(snap => {
                if (snap.empty) {
                    log("‚ö†Ô∏è Teste 1 OK: Conectou, mas cole√ß√£o vazia.", "warning");
                } else {
                    log("‚úÖ Teste 1 OK: Leu banco de dados.", "success");
                }
                // Se passou do 1, tenta o TESTE 2 (Com filtros da Home)
                runTest2(db);
            })
            .catch(err => {
                console.error(err);
                log(`‚ùå ERRO FATAL NO TESTE 1: ${err.message}`, "error");
                checkCommonErrors(err);
            });

        } catch (e) {
            log(`‚ùå Erro de Configura√ß√£o: ${e.message}`, "error");
        }

        function runTest2(db) {
            log("<hr>‚è≥ Teste 2: Filtro da Home (Pronta Entrega + Data)...");
            
            // Simula exatamente o que a Home tenta fazer
            db.collection("products")
                .where("source", "==", "pronta-entrega")
                .orderBy("createdAt", "desc")
                .get()
            .then(snap => {
                log(`‚úÖ Teste 2 OK: Encontrados ${snap.size} produtos para Home.`, "success");
                resDiv.innerHTML = "<h3>üéâ O SITE DEVERIA ESTAR FUNCIONANDO!</h3>Se voc√™ v√™ isso, o problema era cache ou c√≥digo anterior.";
                snap.forEach(d => {
                    resDiv.innerHTML += `<div class="box">${d.data().name} (R$ ${d.data().price})</div>`;
                });
            })
            .catch(err => {
                console.error(err);
                log(`‚ùå ERRO NO TESTE 2: ${err.message}`, "error");
                checkCommonErrors(err);
            });
        }

        function checkCommonErrors(err) {
            if (err.message.includes("permission")) {
                resDiv.innerHTML += `<div class="error">üîê PROBLEMA DE PERMISS√ÉO<br>O Firebase est√° bloqueando o site. Verifique a aba RULES.</div>`;
            }
            if (err.message.includes("index")) {
                const link = err.message.match(/https:\/\/[^\s]+/);
                if (link) {
                    resDiv.innerHTML += `<div class="error">üìâ FALTA UM √çNDICE<br><a href="${link[0]}" target="_blank" style="background:white; padding:10px; display:block; margin-top:10px; text-align:center; font-weight:bold; border:2px solid red;">CLIQUE AQUI PARA CRIAR O √çNDICE</a></div>`;
                }
            }
        }
    </script>
</body>
</html>
