// Buscar Produtos (Modo Diagnóstico)
        async function fetchProducts() {
            loadingMsg.style.display = 'block';
            loadingMsg.innerHTML = 'Carregando essências...'; // Reset mensagem
            loadingMsg.style.color = 'var(--accent-color)';
            grid.innerHTML = '';
            
            try {
                let q = db.collection("products");
                
                // Aplica filtros
                if(currentSecao !== 'todos') {
                    q = q.where("secao", "==", currentSecao);
                }
                
                // Tenta ordenar e filtrar
                q = q.where("source", "==", currentFilter).orderBy("createdAt", "desc");
                
                const snap = await q.get();
                
                if(snap.empty){
                    loadingMsg.style.display = 'none';
                    grid.innerHTML = '<p style="text-align:center; grid-column:1/-1; color:#999;">Nenhum perfume encontrado nesta categoria.</p>';
                    return;
                }

                snap.forEach(d => {
                    const p = d.data();
                    const pf = (p.price||0).toLocaleString('ja-JP');
                    
                    let badge = '';
                    if(p.isFeatured === 'novo') badge = '<span class="badge badge-novo">Lançamento</span>';
                    else if(p.isFeatured === 'destaque') badge = '<span class="badge badge-destaque">Destaque</span>';
                    if((p.estoqueTotal||0) <= 0 && p.source === 'pronta-entrega') badge = '<span class="badge badge-esgotado">Esgotado</span>';

                    const card = document.createElement('a');
                    card.href = `detalhes.html?id=${d.id}`;
                    card.className = 'product-card';
                    card.innerHTML = `
                        ${badge}
                        <div class="product-image-container">
                            <img src="${p.imageUrl || 'https://via.placeholder.com/400x500?text=FC+Perfumaria'}" class="product-image" loading="lazy">
                        </div>
                        <div class="product-info">
                            <div>
                                <div class="product-category">${p.secao}</div>
                                <h3 class="product-name">${p.name}</h3>
                            </div>
                            <div>
                                <div class="product-price">¥${pf}</div>
                                <button class="details-button">Ver Detalhes</button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                loadingMsg.style.display = 'none';
                
            } catch(e) {
                console.error(e);
                // AQUI ESTÁ A MUDANÇA: Mostra o erro real na tela
                loadingMsg.style.display = 'block';
                loadingMsg.style.color = 'red';
                loadingMsg.innerHTML = `
                    <strong>Erro Técnico:</strong><br>
                    ${e.message}<br><br>
                    <small>Se houver um link abaixo, clique nele:</small><br>
                    ${e.message.includes('https://') ? `<a href="${e.message.match(/https:\/\/[^\s]+/)[0]}" target="_blank" style="background:blue; color:white; padding:5px; border-radius:4px; display:inline-block; margin-top:10px;">CRIAR ÍNDICE FALTANTE</a>` : ''}
                `;
            }
        }
