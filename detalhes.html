<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes | FC Perfumaria</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root { 
            --bg-color: #FDFBF7; 
            --primary-color: #1B263B; /* Azul Marinho */
            --accent-color: #Cca43b; /* Bronze */
            --text-color: #333333; 
            --light-text: #666; 
            --border-color: #e0e0e0; 
            --whatsapp-green: #25D366; 
            --error-color: #dc3545; 
        }
        
        body { font-family: 'Montserrat', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); padding-bottom: 80px; }
        
        /* HEADER SIMPLIFICADO */
        header { background-color: #fff; padding: 1rem; border-bottom: 1px solid var(--border-color); }
        header a { color: var(--primary-color); text-decoration: none; font-weight: 600; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px; }
        
        main { max-width: 1000px; margin: 20px auto; padding: 0 20px; }
        
        /* LAYOUT PRODUTO */
        #product-details { display: flex; flex-wrap: wrap; gap: 40px; margin-bottom: 40px; }
        .media-area { flex: 1 1 45%; min-width: 300px; }
        
        /* GALERIA */
        #main-media-display { position: relative; width: 100%; padding-top: 100%; /* Quadrado para perfumes */ margin-bottom: 15px; background-color: #fff; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        #main-media-display img, #main-media-display video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }
        
        #thumbnails { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .thumb-container { width: 70px; height: 70px; border-radius: 4px; cursor: pointer; border: 1px solid var(--border-color); opacity: 0.7; transition: 0.3s; background: #fff; }
        .thumb-container.active { border: 2px solid var(--accent-color); opacity: 1; }
        .thumb-container img { width: 100%; height: 100%; object-fit: cover; }
        
        /* INFO AREA */
        .info-area { flex: 1 1 45%; padding-top: 10px; }
        
        .status-badge { font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; padding: 5px 10px; border-radius: 4px; font-weight: 600; display: inline-block; margin-bottom: 15px; }
        .status-pronta-entrega { background-color: #e6f9e6; color: #1e7e34; border: 1px solid #c3e6cb; }
        .status-sob-encomenda { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        
        h1 { font-family: 'Playfair Display', serif; color: var(--primary-color); margin: 0 0 10px 0; font-size: 2.2em; line-height: 1.1; }
        
        .price { font-size: 1.8em; font-weight: 700; color: var(--primary-color); margin: 15px 0; }
        
        /* SELETORES (ADAPTADOS PARA PERFUME) */
        .variant-group { margin-top: 25px; }
        .variant-group label { font-size: 0.9em; font-weight: 600; color: var(--accent-color); text-transform: uppercase; margin-bottom: 10px; display: block; letter-spacing: 1px; }
        
        .selector-container { display: flex; flex-wrap: wrap; gap: 10px; }
        
        /* Botões de Variante (Substitui as bolinhas de cor) */
        .variant-btn { 
            padding: 10px 20px; 
            border: 1px solid var(--border-color); 
            background: #fff; 
            color: var(--text-color); 
            cursor: pointer; 
            border-radius: 4px; 
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            transition: 0.3s;
            min-width: 60px;
            text-align: center;
        }
        .variant-btn:hover { border-color: var(--accent-color); }
        .variant-btn.active { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        .variant-btn.disabled { background-color: #f5f5f5; color: #ccc; cursor: not-allowed; border-color: #eee; text-decoration: line-through; }
        
        .selected-label { font-weight: bold; color: var(--primary-color); margin-left: 5px; }

        /* BOTÃO COMPRAR */
        .buy-button { 
            display: block; 
            background-color: var(--accent-color); 
            color: #fff; 
            text-align: center; 
            padding: 18px; 
            font-size: 1.1em; 
            font-weight: 700; 
            border-radius: 5px; 
            margin-top: 40px; 
            border: none; 
            cursor: pointer; 
            width: 100%; /* Mobile First */
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: 0.3s;
            box-shadow: 0 4px 10px rgba(204, 164, 59, 0.3);
        }
        .buy-button:hover { background-color: #bfa045; transform: translateY(-2px); }
        .buy-button:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }
        
        /* DESCRIÇÃO E AVALIAÇÕES */
        .description-box { margin-top: 30px; line-height: 1.8; color: var(--light-text); border-top: 1px solid #eee; padding-top: 20px; }
        
        #reviews-section { margin-top: 50px; background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #eee; }
        .review-item { border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 15px; }
        .review-header { display: flex; justify-content: space-between; font-weight: bold; color: var(--primary-color); margin-bottom: 5px; }
        .stars { color: var(--accent-color); }

        /* CARRINHO FLUTUANTE */
        #cart-icon { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background-color: var(--whatsapp-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4); cursor: pointer; z-index: 1000; text-decoration: none; transition: transform 0.2s; }
        #cart-icon:hover { transform: scale(1.1); }
        #cart-count { position: absolute; top: 0; right: 0; background-color: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; display: none; }

    </style>
</head>
<body>

    <header>
        <a href="index.html"><i class="fas fa-arrow-left"></i> Voltar para a Loja</a>
    </header>

    <main>
        <div id="loading" style="text-align:center; padding:50px;">Carregando detalhes...</div>
        
        <div id="product-details" style="display: none;">
            </div>

        <div id="reviews-section">
            <h3 style="font-family:'Playfair Display'; color:var(--primary-color);">Avaliações de Clientes</h3>
            <div id="reviews-container">Carregando...</div>
        </div>
    </main>
    
    <a id="cart-icon" href="carrinho.html">
        <i class="fas fa-shopping-bag"></i>
        <span id="cart-count">0</span>
    </a>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // CONFIGURAÇÃO NOVA FC PERFUMARIA
        const firebaseConfig = {
            apiKey: "AIzaSyDxyqFLm08rqlaemlyYI9gQfrjvddPelJs",
            authDomain: "fc-perfumaria-309fb.firebaseapp.com",
            projectId: "fc-perfumaria-309fb",
            storageBucket: "fc-perfumaria-309fb.firebasestorage.app",
            messagingSenderId: "311935363734",
            appId: "1:311935363734:web:a85cf6ccd93c67d594f0b7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 

        const detailsContainer = document.getElementById('product-details');
        const loadingDiv = document.getElementById('loading');
        
        let currentProductId = new URLSearchParams(window.location.search).get('id');
        let productData = {};
        let selectedLine = null; // Antigo "Color" -> Agora "Linha" (Ex: Malbec Gold)
        let selectedVol = null;  // Antigo "Size" -> Agora "Volume" (Ex: 100ml)

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            if(!currentProductId) return window.location.href = 'index.html';
            fetchProductDetails();
            updateCartIcon();
        });

        async function fetchProductDetails() {
            try {
                const doc = await db.collection("products").doc(currentProductId).get();
                if (!doc.exists) { loadingDiv.innerHTML = "Produto não encontrado."; return; }
                
                productData = doc.data();
                renderProduct();
                fetchReviews();
            } catch (e) { loadingDiv.innerHTML = "Erro ao carregar."; }
        }

        function renderProduct() {
            const p = productData;
            const price = (p.price||0).toLocaleString('ja-JP');
            const hasVariants = p.variantes && Object.keys(p.variantes).length > 0;
            
            // Lógica de Status
            let statusHtml = p.source === 'pronta-entrega' 
                ? '<span class="status-badge status-pronta-entrega"><i class="fas fa-check"></i> Pronta Entrega</span>' 
                : '<span class="status-badge status-sob-encomenda"><i class="fas fa-clock"></i> Sob Encomenda (15-20 dias)</span>';

            // Monta Galeria
            let mediaHtml = `<div id="main-media-display"><img id="main-img" src="${p.imageUrl}"></div>`;
            if(p.galeria && p.galeria.length > 0) {
                let thumbs = `<div class="thumb-container active" onclick="changeImage('${p.imageUrl}', this)"><img src="${p.imageUrl}"></div>`;
                p.galeria.forEach(url => {
                    thumbs += `<div class="thumb-container" onclick="changeImage('${url}', this)"><img src="${url}"></div>`;
                });
                mediaHtml += `<div id="thumbnails">${thumbs}</div>`;
            }

            // Monta Variantes (Linha e Volume)
            let variantsHtml = '';
            if(hasVariants) {
                // 1. Seletor de Linha (Antiga Cor)
                const lines = Object.keys(p.variantes);
                const linesBtns = lines.map(line => `<button class="variant-btn line-selector" data-line="${line}">${line}</button>`).join('');
                
                variantsHtml += `
                    <div class="variant-group">
                        <label>1. Escolha a Versão: <span id="selected-line-label" class="selected-label"></span></label>
                        <div class="selector-container" id="line-container">${linesBtns}</div>
                    </div>
                    
                    <div class="variant-group" id="vol-group" style="opacity:0.5; pointer-events:none;">
                        <label>2. Escolha o Tamanho:</label>
                        <div class="selector-container" id="vol-container"></div>
                    </div>
                `;
            }

            detailsContainer.innerHTML = `
                <div class="media-area">${mediaHtml}</div>
                <div class="info-area">
                    ${statusHtml}
                    <h1>${p.name}</h1>
                    <div class="price">¥${price}</div>
                    
                    ${variantsHtml}
                    
                    <button class="buy-button" id="add-to-cart-btn" ${hasVariants ? 'disabled' : ''}>
                        ${hasVariants ? 'Selecione as opções' : 'Adicionar ao Carrinho'}
                    </button>
                    
                    <div class="description-box">
                        <h3>Sobre a Fragrância</h3>
                        <p>${(p.description || '').replace(/\n/g, '<br>')}</p>
                    </div>
                </div>
            `;

            loadingDiv.style.display = 'none';
            detailsContainer.style.display = 'flex';

            if(hasVariants) setupVariantLogic();
            else setupSimpleCartLogic();
        }

        // --- LÓGICA DE VARIANTES (O CÉREBRO NOVO) ---
        function setupVariantLogic() {
            const lineBtns = document.querySelectorAll('.line-selector');
            const volContainer = document.getElementById('vol-container');
            const volGroup = document.getElementById('vol-group');
            const buyBtn = document.getElementById('add-to-cart-btn');
            const labelLine = document.getElementById('selected-line-label');

            // Clique na Linha
            lineBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Visual
                    lineBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Lógica
                    selectedLine = btn.dataset.line;
                    selectedVol = null;
                    labelLine.textContent = selectedLine;
                    
                    // Renderiza Volumes dessa linha
                    renderVolumes(selectedLine);
                    
                    // Ativa área de volume
                    volGroup.style.opacity = '1';
                    volGroup.style.pointerEvents = 'auto';
                    
                    // Reseta botão compra
                    buyBtn.disabled = true;
                    buyBtn.textContent = "Selecione o Tamanho";
                });
            });

            function renderVolumes(line) {
                const stockData = productData.variantes[line]; // Ex: { '50ml': 5, '100ml': 0 }
                volContainer.innerHTML = '';
                
                Object.keys(stockData).forEach(volKey => {
                    const qty = stockData[volKey];
                    const isSoldOut = qty <= 0;
                    
                    const btn = document.createElement('button');
                    btn.className = `variant-btn vol-selector ${isSoldOut ? 'disabled' : ''}`;
                    btn.textContent = volKey + (isSoldOut ? ' (Esgotado)' : '');
                    if(!isSoldOut) {
                        btn.onclick = () => selectVolume(btn, volKey, qty);
                    }
                    volContainer.appendChild(btn);
                });
            }

            function selectVolume(btn, vol, qty) {
                document.querySelectorAll('.vol-selector').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedVol = vol;
                
                buyBtn.disabled = false;
                buyBtn.innerHTML = `ADICIONAR AO CARRINHO <i class="fas fa-shopping-bag"></i>`;
                
                // Remove listeners antigos para evitar duplicação
                const newBtn = buyBtn.cloneNode(true);
                buyBtn.parentNode.replaceChild(newBtn, buyBtn);
                newBtn.addEventListener('click', () => addToCart(qty));
            }
        }

        function setupSimpleCartLogic() {
            const btn = document.getElementById('add-to-cart-btn');
            const maxStock = productData.estoqueTotal || 999;
            btn.addEventListener('click', () => addToCart(maxStock));
        }

        // --- CARRINHO ---
        function addToCart(maxStock) {
            const cart = JSON.parse(localStorage.getItem('whatsappCart')) || {items:{}};
            
            // ID Único: ID_Linha_Volume (ou ID_padrao_padrao)
            const variantId = selectedLine 
                ? `${currentProductId}_${selectedLine}_${selectedVol}` 
                : `${currentProductId}_padrao`;

            const currentQty = cart.items[variantId] ? cart.items[variantId].quantity : 0;

            if(currentQty >= maxStock) {
                alert("Desculpe, estoque máximo atingido para este item.");
                return;
            }

            if(!cart.items[variantId]) {
                cart.items[variantId] = {
                    id: currentProductId,
                    name: productData.name,
                    price: productData.price,
                    image: productData.imageUrl,
                    // Mapeia para o carrinho novo
                    color: selectedLine || '', // Usa campo 'color' antigo para guardar a Linha
                    size: selectedVol || '',   // Usa campo 'size' antigo para guardar Volume
                    quantity: 0
                };
            }
            
            cart.items[variantId].quantity++;
            localStorage.setItem('whatsappCart', JSON.stringify(cart));
            
            updateCartIcon();
            
            // Feedback Visual
            const btn = document.querySelector('.buy-button');
            const originalText = btn.innerHTML;
            btn.innerHTML = "ADICIONADO! ✓";
            btn.style.backgroundColor = "#25D366"; // Verde WhatsApp
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.backgroundColor = ""; // Volta cor original
            }, 2000);
        }

        function updateCartIcon(){
            const c = JSON.parse(localStorage.getItem('whatsappCart')) || {items:{}};
            let q = 0; Object.values(c.items).forEach(i => q += i.quantity);
            const badge = document.getElementById('cart-count');
            if(q > 0) { badge.textContent = q; badge.style.display = 'flex'; }
            else badge.style.display = 'none';
        }

        // Auxiliares Visuais
        window.changeImage = function(src, el) {
            document.getElementById('main-img').src = src;
            document.querySelectorAll('.thumb-container').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
        }

        // Avaliações (Mantido igual, só CSS novo)
        async function fetchReviews() {
            const div = document.getElementById('reviews-container');
            const snap = await db.collection('reviews').where('productId', '==', currentProductId).get();
            if(snap.empty) { div.innerHTML = '<p style="color:#999; font-style:italic;">Seja o primeiro a avaliar este perfume.</p>'; return; }
            let h = '';
            snap.forEach(d => {
                const r = d.data();
                const stars = '<i class="fas fa-star stars"></i>'.repeat(r.rating);
                h += `<div class="review-item"><div class="review-header"><span>${r.customerName}</span><span>${stars}</span></div><p>"${r.text}"</p></div>`;
            });
            div.innerHTML = h;
        }
    </script>
</body>
</html>
